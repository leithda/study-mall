

# 商城业务-检索服务

## 搭建页面环境

1. 在`study-mall-search`服务中引入模板引擎

```xml
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-thymeleaf</artifactId>
        </dependency>

```

2. 将搜索页面首页`index.html`放入静态资源文件路径`templates`下
3. 页面引入thymeleaf支持

```html
<html lang="en" xmlns:th="http://www.thymeleaf.org">
```

4. 上传静态资源到Nginx~/html/static/search目录下

   创建目录，`mkdir ~/data/nginx/html/static/search`。上传静态资源

5. 配置域名环境

   使用SwitchHosts软件配置如下规则`192.168.56.10 search.mall.com`

6.  配置Nginx转发

   ```nginx
   server {
       listen       80;
       listen  [::]:80;
       server_name  *.mall.com;
   
       #access_log  /var/log/nginx/host.access.log  main;
   
       location /static/ {
           root   /usr/share/nginx/html;
       }
   
       location / {
           proxy_set_header Host $host; # 转发时携带Host请求头
           proxy_pass http://mall;
   
       }
   
       error_page   500 502 503 504  /50x.html;
       location = /50x.html {
           root   /usr/share/nginx/html;
       }
   }
   ```

   - server_name 修改为`*.mall.com`

7. 修改网关配置，根据host进行转发

   ```yaml
           - id: mall_host_route
             uri: lb://product-service
             predicates:
               - Host=mall.com
   
           - id: search_host_route
             uri: lb://search-service
             predicates:
               - Host=search.mall.com
   ```



## 调整页面跳转

1. 加入热部署依赖，关闭thymeleaf缓存

2. 修改页面内跳转路径，product服务下index.html，search服务下index.html

   注：首页静态文件js/catalogLoader.js，要注意跳转路径修改

3. 修改Nginx配置。mall.com和*.mall.com

```nginx
server {
    listen       80;
    listen  [::]:80;
    server_name  mall.com *.mall.com;

    #access_log  /var/log/nginx/host.access.log  main;

    location /static/ {
        root   /usr/share/nginx/html;
    }

    location / {
        proxy_set_header Host $host; # 转发时携带Host请求头
        proxy_pass http://mall;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
```

4. 修改检索服务

   index.html -> list.html

   增加Controller

   ```java
   @Controller
   public class SearchController {
   
       @RequestMapping("list.html")
       public String listPage(){
           return "list";
       }
   }
   ```



## 检索查询参数模型

1. 全文检索： skuTitle -> keyword
2. 排序：saleCount(销量)、hotScore(热度)、skuPrice(价格)
3. 过滤：hasStock(是否有库存)、skuPrice(价格区间)、brandId(品牌，多选)、catelog3Id(分类ID)、attrs(规格属性)
4. 聚合：attrs

完整查询参数

`catelog3Id=225&keyword=小米&sort=saleCount_desc&hasStock=1&skuPrice=1500_4000&brandId=1&brandId=2&attrs=1_其他:安卓&attrs=2_6.4寸:5寸`



封装参数对象如下：

```java
/**
 * 封装页面检索条件
 * catelog3Id=225&keyword=小米&sort=saleCount_desc&hasStock=1&skuPrice=1500_4000&brandId=1&brandId=2&attrs=1_其他:安卓&attrs=2_6.4寸:5寸
 */
@Data
public class SearchParam {
    /**
     * 页面参数，全文匹配关键字 skuTitle->keyword
     */
    private String keyword;

    /**
     * 三级分类Id
     */
    private Long catelog3Id;

    /**
     * 排序条件 saleCount、hotScore、skuPrice
     */
    private String sort;

    /**
     * 是否只显示有货
     */
    private Integer hasStock;

    /**
     * 价格区间
     */
    private String skuPrice;

    /**
     * 按照品牌进行查询，可以多选 brandId=1&brandId=2
     */
    private List<Long> brandId;

    /**
     * 按照属性筛选，可以选多个值，用:分隔 attrs=1_其他:安卓&attrs=2_6.4寸:5寸
     */
    private List<String> attrs;

}
```



## 检索查询结果模型

```java
/**
 * 检索商品结果
 */
@Data
public class SearchResult {

    /** 商品信息 */
    List<ProductEntity> products;

    /** 当前页 */
    private Integer pageNum;

    /** 总记录数 */
    private Long total;

    /** 总页码 */
    private Integer totalPages;

    /** 所有品牌 */
    List<BrandVo> brands;

    /** 所有分类 */
    List<CatelogVo> catelogs;

    /** 所有属性 */
    List<CatelogVo> attrs;

    // ================= 以上是返回给页面的所有信息 =================

    /** 品牌 */
    @Data
    public static class BrandVo {
        private Long brandId;
        /** 品牌名字 */
        private String brandName;

        /** 品牌图片 */
        private String brandImg;
    }


    /** 规格属性 */
    @Data
    public static class AttrVo {
        private Long attrId;
        /** 属性名字 */
        private String attrName;
        /** 属性值 */
        private List<String> attrValue;
    }

    /**  分类 */
    @Data
    public static class CatelogVo {
        private Long catelogId;
        /** 分类名字
         */
        private String catelogName;
    }
}
```

